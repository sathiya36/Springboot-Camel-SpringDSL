<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:camel="http://camel.apache.org/schema/spring"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">


    <camelContext id="CountryInformationService-Camel" xmlns="http://camel.apache.org/schema/spring" trace="false" traceLoggingFormat="%-4.4s [%-30.30s] [%-50.50s]">
        <threadPoolProfile id="defaultThreadPoolProfile" defaultProfile="true" poolSize="10" maxPoolSize="20"/>
        <restConfiguration component="servlet" bindingMode="off" apiContextPath="api-doc">
            <!--<endpointProperty key="handlers" value="swaggerUIHandler"/>-->
            <dataFormatProperty key="prettyPrint" value="true"/>
            <apiProperty key="api.version" value="1.0.0"/>
            <apiProperty key="api.title" value="CountryInformation API"/>
            <apiProperty key="api.description" value="This API is used to get Country Informations"/>
        </restConfiguration>

        <rest path="/CountryInfo" bindingMode="off" consumes="application/json" produces="application/json" enableCORS="true">
            <get id="/GET-getFullCountryInfo" path="/getFullCountryInfo/{CountryCode}" outType="com.sathiya.examples.POJOs.getFullCountryInfoRs" skipBindingOnErrorCode="true">
                <param name="CountryCode" type="path" description="ISO Country Code" dataType="string"/>
                <to uri="direct:getFullCountryInfo-route"/>
            </get>
        </rest>

        <route id="/getFullCountryInfo-Route">
            <from uri="direct:getFullCountryInfo-route"/>
            <onException>
                <exception>java.lang.Exception</exception>
                <handled>
                    <constant>true</constant>
                </handled>
                <log message="tracePoint:END,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Exception:${exception}" loggingLevel="ERROR"/>
            </onException>
            <removeHeader name="*"/>
            <log message="tracePoint:START,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId},CountryCode:${in.headers.CountryCode},Message:${body}" loggingLevel="INFO"/>
            <transform>
                <simple>&lt;Data&gt;&lt;CountryCode&gt;${in.headers.CountryCode}&lt;/CountryCode&gt;&lt;/Data&gt;</simple>
            </transform>
            <multicast stopOnException="true" parallelProcessing="true" timeout="10000" aggregationStrategy="#class:com.sathiya.examples.aggregationStrategy.MergeAggregator">
                <to uri="direct:getCapitalCity"/>
                <to uri="direct:getCountryCurrency"/>
                <to uri="direct:CountryIntPhone"/>
                <to uri="direct:CountryName"/>
            </multicast>
            <choice>
                <when>
                    <simple>${exchangeProperty[ErrorCode]}== '404'</simple>
                    <to uri="direct:error"/>
                </when>
                <otherwise>
                    <transform>
                        <simple>&lt;aggregatedMessage&gt;${body}&lt;/aggregatedMessage&gt;</simple>
                    </transform>
                    <setHeader name="operationName">
                        <simple>getFullCountryInfo</simple>
                    </setHeader>
                    <to uri="xj:xslt/CountryInfoServiceResponse.xsl?transformDirection=XML2JSON"/>
                    <log message="tracePoint:END,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Message-${body}" loggingLevel="INFO"/>
                    <setHeader name="content-type">
                        <constant>"application/json"</constant>
                    </setHeader>
                </otherwise>
            </choice>
        </route>

        <route id="getCapitalCity-Route">
            <from uri="direct:getCapitalCity"/>
            <setHeader name="operationName">
                <simple>CapitalCity</simple>
            </setHeader>
            <setHeader name="Accept-Encoding">
                <constant>*</constant>
            </setHeader>
            <convertBodyTo type="java.lang.String"></convertBodyTo>
            <log message="tracePoint:BEFORE_TRANSFORM,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Message-${body}" loggingLevel="DEBUG"/>
            <to uri="xslt:xslt/CountryInfoServiceRequest.xsl"/>
            <log message="tracePoint:AFTER_TRANSFORM,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Message-${body}" loggingLevel="DEBUG"/>
            <to uri="direct:CountryInfoServiceCall"/>
        </route>

        <route id="getCountryCurrency-Route">
            <from uri="direct:getCountryCurrency"/>
            <setHeader name="operationName">
                <simple>CountryCurrency</simple>
            </setHeader>
            <setHeader name="Accept-Encoding">
                <constant>*</constant>
            </setHeader>
            <convertBodyTo type="java.lang.String"></convertBodyTo>
            <log message="tracePoint:BEFORE_TRANSFORM,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Message-${body}" loggingLevel="DEBUG"/>
            <to uri="xslt:xslt/CountryInfoServiceRequest.xsl"/>
            <log message="tracePoint:AFTER_TRANSFORM,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Message-${body}" loggingLevel="DEBUG"/>
            <to uri="direct:CountryInfoServiceCall"/>
        </route>

        <route id="getCountryIntPhoneCode-Route">
            <from uri="direct:CountryIntPhone"/>
            <setHeader name="operationName">
                <simple>CountryIntPhone</simple>
            </setHeader>
            <setHeader name="Accept-Encoding">
                <constant>*</constant>
            </setHeader>
            <convertBodyTo type="java.lang.String"></convertBodyTo>
            <log message="tracePoint:BEFORE_TRANSFORM,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Message-${body}" loggingLevel="DEBUG"/>
            <to uri="xslt:xslt/CountryInfoServiceRequest.xsl"/>
            <log message="tracePoint:AFTER_TRANSFORM,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Message-${body}" loggingLevel="DEBUG"/>
            <to uri="direct:CountryInfoServiceCall"/>
        </route>

        <route id="getCountryName-Route">
            <from uri="direct:CountryName"/>
            <setHeader name="operationName">
                <simple>CountryName</simple>
            </setHeader>
            <setHeader name="Accept-Encoding">
                <constant>*</constant>
            </setHeader>
            <convertBodyTo type="java.lang.String"></convertBodyTo>
            <log message="tracePoint:BEFORE_TRANSFORM,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Message-${body}" loggingLevel="DEBUG"/>
            <to uri="xslt:xslt/CountryInfoServiceRequest.xsl"/>
            <log message="tracePoint:AFTER_TRANSFORM,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Message-${body}" loggingLevel="DEBUG"/>
            <to uri="direct:CountryInfoServiceCall"/>
        </route>

        <route id="CountryInfoServiceCall-Route">
            <from uri="direct:CountryInfoServiceCall"/>
            <onException>
                <exception>java.lang.Exception</exception>
                <handled>
                    <constant>true</constant>
                </handled>
                <log message="tracePoint:EXCEPTION,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Exception:${exception}" loggingLevel="ERROR"/>
                <to uri="direct:error"/>
            </onException>
            <log message="tracePoint:BEFORE_API_OR_BACKEND,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Message-${body}" loggingLevel="INFO"/>
            <circuitBreaker>
                <to uri="spring-ws:{{countryinfo.service.endpoint}}?timeout={{countryinfo.service.responseTimeout}}"/>
                <onFallback>
                    <setBody>
                        <simple>&lt;message&gt;Circuit Breaker Activated&lt;/message&gt;</simple>
                    </setBody>
                    <setHeader name="Exchange.HTTP_RESPONSE_CODE">
                        <constant>503</constant>
                    </setHeader>
                    <setProperty name="ErrorCode">
                        <constant>404</constant>
                    </setProperty>
                    <log message="tracePoint:FALLBACK,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Message-${body}" loggingLevel="ERROR"/>
                </onFallback>
            </circuitBreaker>
            <convertBodyTo type="java.lang.String"></convertBodyTo>
            <log message="tracePoint:AFTER_API_OR_BACKEND,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Message-${body}" loggingLevel="INFO"/>
            <to uri="xslt:xslt/Remove-Namespaces.xsl"/>
        </route>

        <route id="ErrorHandling-Route">
        <from uri="direct:error"/>
            <setBody>
                <simple>{"message" : "Exception Occured - ${exception}" }</simple>
            </setBody>
            <setHeader name="content-type">
                <constant>"application/json"</constant>
            </setHeader>
            <log message="tracePoint:END,applicationName:${in.headers.CamelHttpUri},exchangeId:${exchangeId}- Exception:${exception}" loggingLevel="ERROR"/>
        </route>
    </camelContext>

</beans>
